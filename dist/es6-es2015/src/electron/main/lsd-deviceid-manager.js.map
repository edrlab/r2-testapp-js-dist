{"version":3,"file":"lsd-deviceid-manager.js","sourceRoot":"","sources":["../../../../../src/electron/main/lsd-deviceid-manager.ts"],"names":[],"mappings":";;;AAAA,gCAAgC;AAChC,6BAA6B;AAM7B,MAAM,KAAK,GAAG,MAAM,CAAC,+CAA+C,CAAC,CAAC;AAEtE,MAAM,+BAA+B,GAAG,WAAW,CAAC;AAEpD,4BAAmC,gBAAwB,EAAE,IAAY;IAErE,MAAM,eAAe,GAAqB;QAEhC,aAAa,CAAC,GAAW;;gBAE3B,MAAM,KAAK,GAAG,+BAA+B,GAAG,GAAG,CAAC;gBAEpD,MAAM,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAC7C,IAAI,CAAC,QAAQ,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE;oBAC/B,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;iBACrC;gBAED,OAAO,OAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;YAC5C,CAAC;SAAA;QAEK,WAAW;;gBAEb,IAAI,EAAE,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;gBAEnB,MAAM,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAC7C,IAAI,CAAC,QAAQ,EAAE;oBACX,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE;wBACxB,QAAQ,EAAE,EAAE;qBACf,CAAC,CAAC;iBACN;qBAAM;oBACH,IAAI,QAAQ,CAAC,QAAQ,EAAE;wBACnB,EAAE,GAAG,QAAQ,CAAC,QAAQ,CAAC;qBAC1B;yBAAM;wBACH,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;wBACvB,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;qBACzC;iBACJ;gBAED,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;YAC/B,CAAC;SAAA;QAEK,aAAa;;gBACf,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YACjC,CAAC;SAAA;QAEK,cAAc,CAAC,GAAW;;gBAE5B,MAAM,EAAE,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;gBAE9B,MAAM,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAC7C,IAAI,CAAC,QAAQ,EAAE;oBAEX,KAAK,CAAC,qBAAqB,CAAC,CAAC;oBAC7B,OAAO,OAAO,CAAC,MAAM,CAAC,uBAAuB,CAAC,CAAC;iBAClD;gBAED,MAAM,KAAK,GAAG,+BAA+B,GAAG,GAAG,CAAC;gBACpD,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;gBACrB,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;gBAEtC,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;YAC7B,CAAC;SAAA;KACJ,CAAC;IACF,OAAO,eAAe,CAAC;AAC3B,CAAC;AA5DD,gDA4DC","sourcesContent":["import * as debug_ from \"debug\";\nimport * as uuid from \"uuid\";\n\nimport { IDeviceIDManager } from \"@r2-lcp-js/lsd/deviceid-manager\";\n\nimport { IStore } from \"../common/store\";\n\nconst debug = debug_(\"r2:testapp#electron/main/lsd-deviceid-manager\");\n\nconst LSD_STORE_DEVICEID_ENTRY_PREFIX = \"deviceID_\";\n\nexport function getDeviceIDManager(electronStoreLSD: IStore, name: string): IDeviceIDManager {\n\n    const deviceIDManager: IDeviceIDManager = {\n\n        async checkDeviceID(key: string): Promise<string | undefined> {\n\n            const entry = LSD_STORE_DEVICEID_ENTRY_PREFIX + key;\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore || !lsdStore[entry]) {\n                return Promise.resolve(undefined);\n            }\n\n            return Promise.resolve(lsdStore[entry]);\n        },\n\n        async getDeviceID(): Promise<string> {\n\n            let id = uuid.v4();\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore) {\n                electronStoreLSD.set(\"lsd\", {\n                    deviceID: id,\n                });\n            } else {\n                if (lsdStore.deviceID) {\n                    id = lsdStore.deviceID;\n                } else {\n                    lsdStore.deviceID = id;\n                    electronStoreLSD.set(\"lsd\", lsdStore);\n                }\n            }\n\n            return Promise.resolve(id);\n        },\n\n        async getDeviceNAME(): Promise<string> {\n            return Promise.resolve(name);\n        },\n\n        async recordDeviceID(key: string): Promise<void> {\n\n            const id = this.getDeviceID();\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore) {\n                // Should be init'ed at this.getDeviceID()\n                debug(\"LSD store problem?!\");\n                return Promise.reject(\"Cannot get LSD store?\");\n            }\n\n            const entry = LSD_STORE_DEVICEID_ENTRY_PREFIX + key;\n            lsdStore[entry] = id;\n            electronStoreLSD.set(\"lsd\", lsdStore);\n\n            return Promise.resolve(); // implicit\n        },\n    };\n    return deviceIDManager;\n}\n"]}