{"version":3,"file":"lsd-deviceid-manager.js","sourceRoot":"","sources":["../../../../../src/electron/main/lsd-deviceid-manager.ts"],"names":[],"mappings":";;AAAA,gCAAgC;AAChC,6BAA6B;AAM7B,MAAM,KAAK,GAAG,MAAM,CAAC,+CAA+C,CAAC,CAAC;AAEtE,MAAM,+BAA+B,GAAG,WAAW,CAAC;AAEpD,4BAAmC,gBAAwB,EAAE,IAAY;IAErE,MAAM,eAAe,GAAqB;QAEtC,KAAK,CAAC,aAAa,CAAC,GAAW;YAE3B,MAAM,KAAK,GAAG,+BAA+B,GAAG,GAAG,CAAC;YAEpD,MAAM,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAC7C,IAAI,CAAC,QAAQ,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE;gBAC/B,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;aACrC;YAED,OAAO,OAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;QAC5C,CAAC;QAED,KAAK,CAAC,WAAW;YAEb,IAAI,EAAE,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;YAEnB,MAAM,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAC7C,IAAI,CAAC,QAAQ,EAAE;gBACX,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE;oBACxB,QAAQ,EAAE,EAAE;iBACf,CAAC,CAAC;aACN;iBAAM;gBACH,IAAI,QAAQ,CAAC,QAAQ,EAAE;oBACnB,EAAE,GAAG,QAAQ,CAAC,QAAQ,CAAC;iBAC1B;qBAAM;oBACH,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACvB,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;iBACzC;aACJ;YAED,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAC/B,CAAC;QAED,KAAK,CAAC,aAAa;YACf,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACjC,CAAC;QAED,KAAK,CAAC,cAAc,CAAC,GAAW;YAE5B,MAAM,EAAE,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;YAE9B,MAAM,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAC7C,IAAI,CAAC,QAAQ,EAAE;gBAEX,KAAK,CAAC,qBAAqB,CAAC,CAAC;gBAC7B,OAAO,OAAO,CAAC,MAAM,CAAC,uBAAuB,CAAC,CAAC;aAClD;YAED,MAAM,KAAK,GAAG,+BAA+B,GAAG,GAAG,CAAC;YACpD,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;YACrB,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;YAEtC,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;QAC7B,CAAC;KACJ,CAAC;IACF,OAAO,eAAe,CAAC;AAC3B,CAAC;AA5DD,gDA4DC","sourcesContent":["import * as debug_ from \"debug\";\nimport * as uuid from \"uuid\";\n\nimport { IDeviceIDManager } from \"@r2-lcp-js/lsd/deviceid-manager\";\n\nimport { IStore } from \"../common/store\";\n\nconst debug = debug_(\"r2:testapp#electron/main/lsd-deviceid-manager\");\n\nconst LSD_STORE_DEVICEID_ENTRY_PREFIX = \"deviceID_\";\n\nexport function getDeviceIDManager(electronStoreLSD: IStore, name: string): IDeviceIDManager {\n\n    const deviceIDManager: IDeviceIDManager = {\n\n        async checkDeviceID(key: string): Promise<string | undefined> {\n\n            const entry = LSD_STORE_DEVICEID_ENTRY_PREFIX + key;\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore || !lsdStore[entry]) {\n                return Promise.resolve(undefined);\n            }\n\n            return Promise.resolve(lsdStore[entry]);\n        },\n\n        async getDeviceID(): Promise<string> {\n\n            let id = uuid.v4();\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore) {\n                electronStoreLSD.set(\"lsd\", {\n                    deviceID: id,\n                });\n            } else {\n                if (lsdStore.deviceID) {\n                    id = lsdStore.deviceID;\n                } else {\n                    lsdStore.deviceID = id;\n                    electronStoreLSD.set(\"lsd\", lsdStore);\n                }\n            }\n\n            return Promise.resolve(id);\n        },\n\n        async getDeviceNAME(): Promise<string> {\n            return Promise.resolve(name);\n        },\n\n        async recordDeviceID(key: string): Promise<void> {\n\n            const id = this.getDeviceID();\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore) {\n                // Should be init'ed at this.getDeviceID()\n                debug(\"LSD store problem?!\");\n                return Promise.reject(\"Cannot get LSD store?\");\n            }\n\n            const entry = LSD_STORE_DEVICEID_ENTRY_PREFIX + key;\n            lsdStore[entry] = id;\n            electronStoreLSD.set(\"lsd\", lsdStore);\n\n            return Promise.resolve(); // implicit\n        },\n    };\n    return deviceIDManager;\n}\n"]}