{"version":3,"file":"lsd-deviceid-manager.js","sourceRoot":"","sources":["../../../../../src/electron/main/lsd-deviceid-manager.ts"],"names":[],"mappings":";;;AAOA,8BAAgC;AAChC,2BAA6B;AAM7B,IAAM,KAAK,GAAG,MAAM,CAAC,+CAA+C,CAAC,CAAC;AAEtE,IAAM,+BAA+B,GAAG,WAAW,CAAC;AAEpD,4BAAmC,gBAAwB,EAAE,IAAY;IAErE,IAAM,eAAe,GAAqB;QAEhC,aAAa,EAAnB,UAAoB,GAAW;;;;oBAErB,KAAK,GAAG,+BAA+B,GAAG,GAAG,CAAC;oBAE9C,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;oBAC7C,IAAI,CAAC,QAAQ,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE;wBAC/B,WAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,EAAC;qBACrC;oBAED,WAAO,OAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAC;;;SAC3C;QAEK,WAAW,EAAjB;;;;oBAEQ,EAAE,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;oBAEb,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;oBAC7C,IAAI,CAAC,QAAQ,EAAE;wBACX,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE;4BACxB,QAAQ,EAAE,EAAE;yBACf,CAAC,CAAC;qBACN;yBAAM;wBACH,IAAI,QAAQ,CAAC,QAAQ,EAAE;4BACnB,EAAE,GAAG,QAAQ,CAAC,QAAQ,CAAC;yBAC1B;6BAAM;4BACH,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;4BACvB,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;yBACzC;qBACJ;oBAED,WAAO,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,EAAC;;;SAC9B;QAEK,aAAa,EAAnB;;;oBACI,WAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,EAAC;;;SAChC;QAEK,cAAc,EAApB,UAAqB,GAAW;;;;oBAEtB,EAAE,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;oBAExB,QAAQ,GAAG,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;oBAC7C,IAAI,CAAC,QAAQ,EAAE;wBAEX,KAAK,CAAC,qBAAqB,CAAC,CAAC;wBAC7B,WAAO,OAAO,CAAC,MAAM,CAAC,uBAAuB,CAAC,EAAC;qBAClD;oBAEK,KAAK,GAAG,+BAA+B,GAAG,GAAG,CAAC;oBACpD,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;oBACrB,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;oBAEtC,WAAO,OAAO,CAAC,OAAO,EAAE,EAAC;;;SAC5B;KACJ,CAAC;IACF,OAAO,eAAe,CAAC;AAC3B,CAAC;AA5DD,gDA4DC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport * as uuid from \"uuid\";\n\nimport { IDeviceIDManager } from \"@r2-lcp-js/lsd/deviceid-manager\";\n\nimport { IStore } from \"../common/store\";\n\nconst debug = debug_(\"r2:testapp#electron/main/lsd-deviceid-manager\");\n\nconst LSD_STORE_DEVICEID_ENTRY_PREFIX = \"deviceID_\";\n\nexport function getDeviceIDManager(electronStoreLSD: IStore, name: string): IDeviceIDManager {\n\n    const deviceIDManager: IDeviceIDManager = {\n\n        async checkDeviceID(key: string): Promise<string | undefined> {\n\n            const entry = LSD_STORE_DEVICEID_ENTRY_PREFIX + key;\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore || !lsdStore[entry]) {\n                return Promise.resolve(undefined);\n            }\n\n            return Promise.resolve(lsdStore[entry]);\n        },\n\n        async getDeviceID(): Promise<string> {\n\n            let id = uuid.v4();\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore) {\n                electronStoreLSD.set(\"lsd\", {\n                    deviceID: id,\n                });\n            } else {\n                if (lsdStore.deviceID) {\n                    id = lsdStore.deviceID;\n                } else {\n                    lsdStore.deviceID = id;\n                    electronStoreLSD.set(\"lsd\", lsdStore);\n                }\n            }\n\n            return Promise.resolve(id);\n        },\n\n        async getDeviceNAME(): Promise<string> {\n            return Promise.resolve(name);\n        },\n\n        async recordDeviceID(key: string): Promise<void> {\n\n            const id = this.getDeviceID();\n\n            const lsdStore = electronStoreLSD.get(\"lsd\");\n            if (!lsdStore) {\n                // Should be init'ed at this.getDeviceID()\n                debug(\"LSD store problem?!\");\n                return Promise.reject(\"Cannot get LSD store?\");\n            }\n\n            const entry = LSD_STORE_DEVICEID_ENTRY_PREFIX + key;\n            lsdStore[entry] = id;\n            electronStoreLSD.set(\"lsd\", lsdStore);\n\n            return Promise.resolve(); // implicit\n        },\n    };\n    return deviceIDManager;\n}\n"]}